# Vulnerable Driver  RTKVHD64.sys in Realtek Semiconductor Corp Realtek(r) High Definition Audio Function Driver v6.0.9549.1

---

RTKVHD64.sys in Realtek Semiconductor Corp Realtek(r) High Definition Audio Function Driver v6.0.9549.1 exposes functionality that allows low-privileged users to map arbitrary physical memory, read and write i/o port via specially crafted IOCTL requests. This can be exploited for privilege escalation, code execution under high privileges, and information disclosure. These signed drivers can also be used to bypass the Microsoft driver-signing policy to deploy malicious code.  

## version

6.0.9549.1

## Vulnerability causes

RTKVHD64.sys provides the functionality of mapping physical memory, read/write I/O ports, but it does not restrict the privileges of the caller, resulting in low-privileged users being able to call the driver and execute corresponding functions through DeviceIoControl. The driver exposes memory mapping operation by MmMapIoSpace and MmMapLockedPagesSpecifyCache, exposes port io operation by in/out instruction. The ioctler is located at offset 0x59C190 as below.

```c
__int64 __fastcall ioctler(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)
{
  struct _IO_STACK_LOCATION *CurrentStackLocation; // rsi
  _DWORD *v4; // rbp
  unsigned int Status; // ebx
  PFILE_OBJECT FileObject; // rdx
  unsigned int v8; // eax
  PFILE_OBJECT v9; // rdx
  int v10; // ebx
  int v11; // r14d
  int v12; // eax
  PNAMED_PIPE_CREATE_PARAMETERS Parameters; // rcx
  KIRQL CurrentIrql; // si
  unsigned int v16; // edi
  ULONG InboundQuota; // eax

  CurrentStackLocation = pIrp->Tail.Overlay.CurrentStackLocation;
  v4 = (char *)pDeviceObject->DeviceExtension + 512;
  Status = -1073741823;
  if ( *((_DWORD *)pDeviceObject->DeviceExtension + 172) )
  {
    pIrp->IoStatus.Status = -1073741823;
LABEL_24:
    pIrp->IoStatus.Information = 0i64;
    goto LABEL_27;
  }
  FileObject = CurrentStackLocation->FileObject;
  if ( FileObject && !RtlCompareUnicodeString((PCUNICODE_STRING)&stru_1401D9AC0.Queue, &FileObject->FileName, 1u) )
  {
    if ( CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2508800
      || CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2508804
      || CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2508808
      || CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2525188
      || CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2525192 )
    {
      v8 = sub_1403FC494(v4 + 46, CurrentStackLocation->Parameters.Read.ByteOffset.LowPart, pIrp);
LABEL_11:
      Status = v8;
LABEL_27:
      IofCompleteRequest(pIrp, 0);
      return Status;
    }
LABEL_23:
    pIrp->IoStatus.Status = Status;
    goto LABEL_24;
  }
  v9 = CurrentStackLocation->FileObject;
  if ( v9 && !RtlCompareUnicodeString((PCUNICODE_STRING)&stru_1401D9AC0.Queue.Wcb.DeviceContext, &v9->FileName, 1u) )
  {
    if ( DeviceObject != (PDEVICE_OBJECT)&DeviceObject
      && (HIDWORD(DeviceObject->Timer) & 0x20) != 0
      && BYTE1(DeviceObject->Timer) >= 4u )
    {
      sub_140016898(DeviceObject->AttachedDevice, 59i64, &unk_140167840);
    }
    if ( CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2229312
      || CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 2229316 )
    {
      v8 = sub_1403FCCE8(v4 + 46, CurrentStackLocation->Parameters.Read.ByteOffset.LowPart, pIrp);
      goto LABEL_11;
    }
  }
  v10 = 0;
  v11 = 0;
  if ( CurrentStackLocation->Parameters.Read.ByteOffset.LowPart == 3080195 )
  {
    if ( CurrentStackLocation->Parameters.Create.Options < 0x18 )
      goto LABEL_33;
    Parameters = CurrentStackLocation->Parameters.CreatePipe.Parameters;
    if ( *(_QWORD *)&Parameters->NamedPipeType == 0x47292F78A855A48Ci64
      && *(_QWORD *)&Parameters->CompletionMode == 0xEF9E6B7468195190ui64 )
    {
      if ( ((Parameters->InboundQuota - 1) & 0xFFFFFFFB) == 0 )
        goto LABEL_33;
    }
    else
    {
      if ( *(_QWORD *)&Parameters->NamedPipeType != 0x11D06E1B45FFAAA0i64
        || *(_QWORD *)&Parameters->CompletionMode != 0x54534544F2BCi64 )
      {
        goto LABEL_33;
      }
      InboundQuota = Parameters->InboundQuota;
      if ( InboundQuota != 50 && InboundQuota != 5 )
      {
        if ( InboundQuota - 52 <= 2 )
          v11 = 1;
        goto LABEL_33;
      }
    }
    v10 = 1;
  }
  else
  {
    v12 = sub_1403FC6E0(v4 + 46, pDeviceObject, pIrp);
    Status = -1073741811;
    if ( v12 == -1073741811 )
      goto LABEL_23;
    v10 = 0;
    if ( v12 >= 0 )
    {
      Status = pIrp->IoStatus.Status;
      goto LABEL_27;
    }
  }
LABEL_33:
  CurrentIrql = KeGetCurrentIrql();
  if ( !CurrentIrql && *v4 && !v11 )
    KeWaitForSingleObject((char *)v4 + (v10 != 0 ? 64i64 : 8i64), Executive, 0, 0, 0i64);
  v16 = PcDispatchIrp(pDeviceObject, pIrp);
  if ( !CurrentIrql && *v4 && !v11 )
    KeReleaseMutex((PRKMUTEX)((char *)v4 + (v10 != 0 ? 64i64 : 8i64)), 0);
  return v16;
}
```

